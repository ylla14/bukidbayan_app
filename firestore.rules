rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is the owner
    function isOwner(ownerId) {
      return isAuthenticated() && request.auth.uid == ownerId;
    }

    // Equipment collection rules
    match /equipment/{equipmentId} {
      // Anyone can read available equipment (for browsing)
      allow read: if resource.data.isAvailable == true;

      // Allow owner to read their own equipment even if not available
      allow read: if isOwner(resource.data.ownerId);

      // Only authenticated users can create equipment
      // Ensure the ownerId matches the authenticated user
      allow create: if isAuthenticated()
                    && request.resource.data.ownerId == request.auth.uid
                    && request.resource.data.keys().hasAll([
                      'name',
                      'description',
                      'power',
                      'condition',
                      'price',
                      'rentalUnit',
                      'ownerId'
                    ]);

      // Only owner can update their equipment
      // Prevent changing ownerId
      allow update: if isOwner(resource.data.ownerId)
                    && request.resource.data.ownerId == resource.data.ownerId;

      // Only owner can delete their equipment
      allow delete: if isOwner(resource.data.ownerId);
    }

    // Bookings collection rules
    match /bookings/{bookingId} {
      // Users can read bookings they're involved in (as renter or owner)
      allow read: if isAuthenticated()
                  && (resource.data.renterId == request.auth.uid
                      || resource.data.ownerId == request.auth.uid);

      // Authenticated users can create bookings as renters
      // Ensure the renterId matches the authenticated user
      allow create: if isAuthenticated()
                    && request.resource.data.renterId == request.auth.uid
                    && request.resource.data.keys().hasAll([
                      'equipmentId',
                      'ownerId',
                      'renterId',
                      'startDate',
                      'endDate',
                      'totalPrice'
                    ]);

      // Both renter and owner can update booking
      // Typically for status changes (confirm, cancel, complete)
      allow update: if isAuthenticated()
                    && (resource.data.renterId == request.auth.uid
                        || resource.data.ownerId == request.auth.uid);

      // Only renter can delete pending bookings
      allow delete: if isAuthenticated()
                    && resource.data.renterId == request.auth.uid
                    && resource.data.status == 'pending';
    }

    // Users collection rules
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);

      // Users can update their own profile
      // Prevent changing critical fields like createdAt
      allow update: if isOwner(userId)
                    && !request.resource.data.diff(resource.data).affectedKeys()
                      .hasAny(['createdAt']);

      // User creation is handled by Cloud Functions or Auth triggers
      // Disable direct creation from client
      allow create: if false;

      // Users cannot delete their own profile (use Cloud Functions)
      allow delete: if false;
    }
  }
}
